<!DOCTYPE html>
<html lang="en">
<head>
  <title>Covid Calculator</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <!-- <script src="https://unpkg.com/vue@next"></script>  -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>

  <script src="https://unpkg.com/vue-multiselect@2.1.0"></script>
  <link rel="stylesheet" href="https://unpkg.com/vue-multiselect@2.1.0/dist/vue-multiselect.min.css">

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


  <link href="https://cdn.pydata.org/bokeh/release/bokeh-2.3.0.min.css" rel="stylesheet">
  <link href="https://cdn.pydata.org/bokeh/release/bokeh-widgets-2.3.0.min.css" rel="stylesheet">
  <link href="https://cdn.pydata.org/bokeh/release/bokeh-tables-2.3.0.min.css" rel="stylesheet">
  
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-2.3.0.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.3.0.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.3.0.min.js" crossorigin="anonymous"></script>


</head>
<body>

<div class="container-fluid"  id="app">

    <h1>Covid Calculator</h1>


    <div class="row">

        <!-- LEFT PANEL -->
        <div class="col-sm-6">

            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="active"><a href="#load" role="tab" data-toggle="tab">Load</a></li>
                <li><a href="#simul" role="tab" data-toggle="tab">Simul</a></li>
            </ul>
        
            <!-- Tab panes -->
            <div class="tab-content">

                <!-- FORM TO LOAD DATA -->
                <div class="tab-pane active" id="load">


                    <form class="form-horizontal" @submit.prevent="load_data">
                        
                        <p></p>
                        <p>Load Fatality and Test results for one or several places:</p>
        
                        <div class="form-group">
                            <label class="control-label col-sm-3" for="region">Region:</label>
                            <div class="col-sm-6">
                                <select v-model="region" class="col-sm-3 form-control">
                                    <option v-for="r in listRegion">{{ r }}</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-sm-3" for="region">State:</label>
                            <div class="col-sm-6">
                                <select v-model="state" class="col-sm-3 form-control" v-if="region">
                                    <option v-for="s in listState[region]" :value=s>{{s}}</option>
                                </select>
                            </div>
                        </div>

                        <button>Load</button>
                        
                    </form>

                </div>

                <!-- FORM TO SIMULATE DATA -->
                <div class="tab-pane" id="simul">

                    <form class="form-horizontal" action="/simul">
        
                        <div class="table-responsive table-hover col-sm-2">
                            <table  class="table">
                                <tr>
                                    <td>R0</td><td>3.5</td>
                                </tr>
                                <tr>
                                    <td>50</td><td>0.8</td>
                                </tr>
                            </table>
                        </div>
        
                        <div class="table-responsive table-hover col-sm-2">
                            <table  class="table">
                                <tr>
                                    <td>R0</td><td>3.5</td>
                                </tr>
                                <tr>
                                    <td>50</td><td>0.8</td>
                                </tr>
                            </table>
                        </div>
        
                    </form>

                </div>

            </div>

        </div>

        <!-- RIGHT PANEL -->
        <div class="col-sm-6">

            <div>
                <!-- https://vue-multiselect.js.org/#sub-option-groups -->
                <multiselect  
                    v-model="selected" 
                    :multiple="true" 
                    :hide-selected="true" 
                    :options="options"
                    group-values="series"
                    group-label="source"
                    :group-select="true"
                    track-by="id"
                    label="id"
                >
                </multiselect>

            </div>

            <form class="form-horizontal" action="/plot">
                <div class="form-group">
                    <label class="col-sm-2">Log Scale</label>
                    <input type="checkbox" class="col-sm-1" name="log" id="log">
                    <label class="col-sm-2">Per 100k</label>
                    <input type="checkbox" class="col-sm-1" name="relative" id="relative">
                </div>
            </form>

            <button @click='plot'>Plot</button>

            <div class="col-sm-6" id="plot"></div>

        </div>
    </div>
</div>


<script>

    //place holder for the in-memory store of available series to plot
    //used by the <multiselect> object
    var ChartSelectionArray = [
        {
            source: "New York",
            series: [
                {id: "New York-Susceptible", name: "Susceptible"},
                {id: "New York-Infectious", name: "Infectious"},
            ]
        },
        {
            source: "California",
            series: [
                {id: "California-Susceptible", name: "Susceptible"},
                {id: "California-Infectious", name: "Infectious"},
            ]
        }
    ];

    function register_data(data) {
        var index = ChartSelectionArray.findIndex(x => x.source==data.source); 
        index === -1 ? ChartSelectionArray.push(data) : console.log("object already exists");
    }
    
    function load_data(event) {
        
        const formData = {
            region: this.region,
            state: this.state,
            county: ''
        };
        
        axios.post('/load',formData)
            .then(function(response){
                console.log(response.data);
                register_data(response.data);
            })
            .catch(function(error) {
                console.log(error);
            });
    }

    function plot() {
        
        var data = this.selected;
        axios.post('/plot',data)
            .then(function(response){
                //var item = JSON.parse(response);
                Bokeh.embed.embed_item(response.data, "plot");
            })
            .catch(function(error) {
                console.log(error);
            });
            

    }

    var RootComponentData = {

        //CHART SELECTION
        selected: [],
        options: ChartSelectionArray,

        //LOAD form
        //region-state dropdowns
        region: "US",
        state: '',
        listRegion:  [ "US", "Europe" ],
        listState: {
            US: ['', 'New York', 'California'],
            Europe: ['', 'France', 'Spain']    
        }
    };


    new Vue({
        el: '#app',
        components: {
            multiselect: VueMultiselect.Multiselect
        },
        data: RootComponentData,
        methods: {
            load_data,
            plot
        }
    });
</script>

</body>
</html>